<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestionnaire de Clients</title>
  <!-- Tailwind CSS (design moderne) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- jsPDF + AutoTable (PDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <!-- SheetJS (Excel) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">
  <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8">
    <h1 class="text-2xl md:text-3xl font-bold text-center text-gray-800">📋 Gestionnaire de Clients</h1>

    <!-- Formulaire -->
    <form id="clientForm" class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-3">
      <input type="hidden" id="editIndex" />
      <div class="md:col-span-1">
        <label class="block text-sm font-semibold text-gray-700 mb-1">Nom</label>
        <input id="nom" type="text" required class="w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Dupont" />
      </div>
      <div class="md:col-span-1">
        <label class="block text-sm font-semibold text-gray-700 mb-1">Prénom</label>
        <input id="prenom" type="text" required class="w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Alice" />
      </div>
      <div class="md:col-span-1">
        <label class="block text-sm font-semibold text-gray-700 mb-1">Email</label>
        <input id="email" type="email" required class="w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="alice@exemple.com" />
      </div>
      <div class="md:col-span-1">
        <label class="block text-sm font-semibold text-gray-700 mb-1">Téléphone</label>
        <input id="telephone" type="tel" required class="w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="+229 96 32 69 77" />
      </div>
      <div class="md:col-span-4 flex flex-wrap gap-2 pt-1">
        <button type="submit" class="px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-semibold">💾 Enregistrer</button>
        <button type="button" id="resetBtn" class="px-4 py-2 rounded-xl bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold">↺ Réinitialiser</button>
      </div>
    </form>

    <!-- Outils -->
    <div class="mt-6 flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
      <input id="search" type="text" class="w-full md:w-1/2 border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
             placeholder="🔍 Rechercher par nom, prénom, email ou téléphone..." />
      <div class="flex flex-wrap gap-2">
        <button id="exportPdfBtn" class="px-4 py-2 rounded-xl bg-red-600 hover:bg-red-700 text-white font-semibold">Export PDF</button>
        <button id="exportXlsxBtn" class="px-4 py-2 rounded-xl bg-green-600 hover:bg-green-700 text-white font-semibold">Export Excel</button>
        <button id="exportCsvBtn" class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white font-semibold">Export CSV</button>
        <button id="clearAllBtn" class="px-4 py-2 rounded-xl bg-rose-600 hover:bg-rose-700 text-white font-semibold">🗑️ Tout supprimer</button>
      </div>
    </div>

    <!-- Tableau -->
    <div class="mt-4 overflow-x-auto rounded-xl border">
      <table class="min-w-full">
        <thead class="bg-gray-50 text-gray-700 text-sm">
          <tr>
            <th class="px-4 py-3 text-left">Nom</th>
            <th class="px-4 py-3 text-left">Prénom</th>
            <th class="px-4 py-3 text-left">Email</th>
            <th class="px-4 py-3 text-left">Téléphone</th>
            <th class="px-4 py-3 text-center">Actions</th>
          </tr>
        </thead>
        <tbody id="clientTable" class="divide-y text-gray-800"></tbody>
      </table>
    </div>

    <!-- Compteurs -->
    <div class="mt-3 text-sm text-gray-600" id="stats"></div>
  </div>

  <script>
    // ------- State & helpers -------
    const LS_KEY = "clients_db";
    let clients = JSON.parse(localStorage.getItem(LS_KEY) || "[]");

    const $ = (id) => document.getElementById(id);
    const form = $("clientForm");
    const tableBody = $("clientTable");
    const stats = $("stats");

    function save() {
      localStorage.setItem(LS_KEY, JSON.stringify(clients));
    }

    function clearForm() {
      form.reset();
      $("editIndex").value = "";
    }

    function toast(msg) {
      // Simple toast (alert), tu peux remplacer par une UI custom si tu veux
      console.log(msg);
    }

    // ------- Render -------
    function render() {
      const q = $("search").value.trim().toLowerCase();
      tableBody.innerHTML = "";

      const filtered = clients.filter(c =>
        [c.nom, c.prenom, c.email, c.telephone].join(" ").toLowerCase().includes(q)
      );

      filtered.forEach((c, idx) => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-gray-50";
        tr.innerHTML = `
          <td class="px-4 py-3">${escapeHtml(c.nom)}</td>
          <td class="px-4 py-3">${escapeHtml(c.prenom)}</td>
          <td class="px-4 py-3">${escapeHtml(c.email)}</td>
          <td class="px-4 py-3">${escapeHtml(c.telephone)}</td>
          <td class="px-4 py-3 text-center">
            <button class="px-3 py-1 rounded-lg bg-yellow-500 hover:bg-yellow-600 text-white font-medium mr-1" data-action="edit" data-index="${idx}">✏️</button>
            <button class="px-3 py-1 rounded-lg bg-red-500 hover:bg-red-600 text-white font-medium" data-action="delete" data-index="${idx}">🗑️</button>
          </td>
        `;
        tableBody.appendChild(tr);
      });

      stats.textContent = `${filtered.length} affiché(s) / ${clients.length} au total`;
      save();
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // ------- CRUD -------
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const nom = $("nom").value.trim();
      const prenom = $("prenom").value.trim();
      const email = $("email").value.trim();
      const telephone = $("telephone").value.trim();
      const editIndex = $("editIndex").value;

      if (!nom || !prenom || !email || !telephone) {
        alert("Veuillez remplir tous les champs.");
        return;
      }
      // petite règle de doublon email (optionnelle)
      const exists = clients.some((c, i) => c.email.toLowerCase() === email.toLowerCase() && String(i) !== String(editIndex || -1));
      if (exists) {
        alert("Cet email existe déjà dans la base.");
        return;
      }

      const client = { nom, prenom, email, telephone };

      if (editIndex === "") {
        clients.push(client);
        toast("Client ajouté.");
      } else {
        clients[Number(editIndex)] = client;
        toast("Client modifié.");
      }

      clearForm();
      render();
    });

    tableBody.addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;
      const action = btn.getAttribute("data-action");
      const index = Number(btn.getAttribute("data-index"));
      if (action === "edit") {
        const c = clients[index];
        $("nom").value = c.nom;
        $("prenom").value = c.prenom;
        $("email").value = c.email;
        $("telephone").value = c.telephone;
        $("editIndex").value = index;
        window.scrollTo({ top: 0, behavior: "smooth" });
      } else if (action === "delete") {
        if (confirm("Supprimer ce client ?")) {
          clients.splice(index, 1);
          render();
        }
      }
    });

    $("resetBtn").addEventListener("click", clearForm);
    $("clearAllBtn").addEventListener("click", () => {
      if (clients.length === 0) return;
      if (confirm("Supprimer tous les clients ?")) {
        clients = [];
        render();
      }
    });

    $("search").addEventListener("input", render);

    // ------- Export PDF -------
    $("exportPdfBtn").addEventListener("click", () => {
      if (clients.length === 0) return alert("Aucune donnée à exporter.");
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "pt", format: "a4" });
      doc.setFont("helvetica", "bold");
      doc.setFontSize(14);
      doc.text("Liste des Clients", 40, 40);

      const rows = clients.map(c => [c.nom, c.prenom, c.email, c.telephone]);
      doc.autoTable({
        head: [["Nom", "Prénom", "Email", "Téléphone"]],
        body: rows,
        startY: 60,
        styles: { fontSize: 10, cellPadding: 6 }
      });
      doc.save("clients.pdf");
    });

    // ------- Export Excel -------
    $("exportXlsxBtn").addEventListener("click", () => {
      if (clients.length === 0) return alert("Aucune donnée à exporter.");
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(clients);
      XLSX.utils.book_append_sheet(wb, ws, "Clients");
      XLSX.writeFile(wb, "clients.xlsx");
    });

    // ------- Export CSV (bonus) -------
    $("exportCsvBtn").addEventListener("click", () => {
      if (clients.length === 0) return alert("Aucune donnée à exporter.");
      const header = ["Nom","Prénom","Email","Téléphone"];
      const lines = clients.map(c => [c.nom, c.prenom, c.email, c.telephone]
        .map(v => `"${String(v).replace(/"/g,'""')}"`).join(","));
      const csv = [header.join(","), ...lines].join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "clients.csv"; a.click();
      URL.revokeObjectURL(url);
    });

    // ------- Init -------
    render();
  </script>
</body>
</html>
